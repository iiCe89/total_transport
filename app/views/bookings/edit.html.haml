- content_for :top_sec do
  %section.section
    %h2
      = t('bookings.title')

  %section.section
    %section.key
      %section.markers
        %section
          = fa_icon 'circle-o'
        %section.link
        %section
          = fa_icon 'map-marker'
      %section.info-wrap
        %span.top
          %h3.title
            = @booking.pickup_stop.name
        %span.bottom
          %h3.title
            = @booking.dropoff_stop.name

  = form_for [@route, @booking], url: route_booking_path(@route, @booking), method: :put do |form|

    = render 'days', form: form
    
    #times.hidden
      = render 'times', form: form, journey_type: :journey_id, type: 'outward'
      
      = render 'times', form: form, journey_type: :return_journey_id, type: 'return'
    
    %section.section
      .landmarks.hidden
        = form.label :pickup_landmark_id, 'Please choose a pickup point'
        = form.select :pickup_landmark_id,
            options_from_collection_for_select(@booking.pickup_stop.landmarks, 'id', 'name'),
            { include_blank: '-- Please Select --' },
            { class: 'select' }
        
        = form.label :pickup_landmark_id, 'Please choose a dropoff point'
        = form.select :dropoff_landmark_id,
            options_from_collection_for_select(@booking.dropoff_stop.landmarks, 'id', 'name'),
            { include_blank: '-- Please Select --'},
            { class: 'select' }
    
    #details.hidden      
      .concessions

        %section.section
          %h3
            = form.label :number_of_passengers
          = form.select :number_of_passengers, 1..10

        %section.section
          #add-concession{:class => "add button secondary #{" hidden" if @booking.number_of_adults == 0}"}
            %i.fa.fa-plus
            Add a Concessionary Fare
        
          %p#adult-tickets{:class => "#{" hidden" if @booking.number_of_adults == 0}"}
            %span#adult-ticket-no= pluralize @booking.number_of_adults, "adult ticket"
            (#{number_to_currency(@booking.adult_single_price, :unit => "£")} each)


          %p{id: 'concession-1', :class => "concession-cont#{" hidden" if @booking.child_tickets == 0}"}
            %span.count= @booking.child_tickets
            Child fare (#{number_to_currency(@booking.child_single_price, :unit => "£")} each)
            = fa_icon 'times', class: 'cancel-concession'

          %p{id: 'concession-2', :class => "concession-cont#{" hidden" if @booking.older_bus_passes == 0}"}
            %span.count= @booking.older_bus_passes
            Older persons bus pass (£0.00 each)
            = fa_icon 'times', class: 'cancel-concession'

          %p{id: 'concession-3', :class => "concession-cont#{" hidden" if @booking.disabled_bus_passes == 0}"}
            %span.count= @booking.disabled_bus_passes
            Disabled persons bus pass (£0.00 each)
            = fa_icon 'times', class: 'cancel-concession'

          %p{id: 'concession-4', :class => "concession-cont#{" hidden" if @booking.scholar_bus_passes == 0}"}
            %span.count= @booking.scholar_bus_passes
            Scholarly Season Ticket (£0.00 each)
            = fa_icon 'times', class: 'cancel-concession'

          %select#concession-list.hidden.select
            %option#option-null{:value => "0"} Select a Concession
            %option#option-1.non-promo{:value => "1"} Child fare
            %option#option-2.non-promo{:value => "2"} Older persons bus pass
            %option#option-3.non-promo{:value => "3"} Disabled persons bus pass
            %option#option-4.non-promo{:value => "4"} Scholarly Season Ticket
            %option#promo{:value => "5"} Add Promo Code

          .promo-code.hidden
            = form.label :promo_code
            = form.text_field :promo_code
          .hidden
            = form.label :child_tickets, "Child fare"
            = form.number_field :child_tickets, :id => "hidden-1"
            = form.label :older_bus_passes
            = form.number_field :older_bus_passes, :id => "hidden-2"
            = form.label :disabled_bus_passes
            = form.number_field :disabled_bus_passes, :id => "hidden-3"
            = form.label :scholar_bus_passes
            = form.number_field :scholar_bus_passes, :id => "hidden-4"
        %section.section  
          #add.button.secondary
            %i.fa.fa-plus
            Add Special Requirements
          #special-req.hidden
            = form.label :special_requirements, "Describe your special requirements:"
            = form.text_field :special_requirements

        %section.section
          %p 
            Your transport provider will get in touch with you if they can't meet your needs
        
          = form.label :passenger_name, "Lead Passenger's Name"
          = form.text_field :passenger_name


          = form.label :phone_number
          = form.text_field :phone_number
          %p
            Let us know your phone number so that we can notify you when your vehicle is on its way.
        %section.section            
          = form.submit "Submit your booking request", :class => 'button', :id => 'submit-booking'

- content_for :js do
  :javascript
    
    $('.date-button').click(function() {
      var target = $(this).data('selector');
      var type = $(this).data('type');
      $('#times').removeClass('hidden');
      $('#times .time').addClass('hidden');
      $(' .' + target).removeClass('hidden');
    })
    
    $('#return_times input').click(function() {
      $('.landmarks').removeClass('hidden');
    });
    
    $('#booking_dropoff_landmark_id').change(function() {
      $('#return-chooser').removeClass('hidden');
      $('#details').removeClass('hidden');
    });
    
    var noOfAdults = 0,
    previousPassengers = 0,
    currentConcessions = 0;

    $('#add').click(function() {
      if ($(this).hasClass('cancel')) {
        $(this).removeClass('cancel').html('<i class="fa fa-plus"></i> Add Special Requirements');
        $('#special-req').addClass('hidden');
        $('#special-req input').val('');
      } else {
        $(this).addClass('cancel').html('<i class="fa fa-minus"></i> Remove Requirements');
        $('#special-req').removeClass('hidden');
      }
    });

    $('#booking_number_of_passengers').on('focus', function () {
        previousPassengers = this.value;
      }).on('change', function() {
      var noOfPassengers = $(this).val();
      if (noOfPassengers > (currentConcessions-1)) {
        checkPassengers(noOfPassengers);
        noOfAdults = noOfPassengers - currentConcessions;
        if (noOfAdults <= 0) {
          if (noOfAdults <= 0) {
            if (!$('.promo-code').hasClass('hidden')) {
              $('#add-concession').addClass('hidden');
            } else {
              $('#concession-list .non-promo').hide();
            }
          }
        } else {
          $('#concession-list .non-promo').show();
          if ($('#add-concession').hasClass('hidden')) {
            $('#add-concession').removeClass('hidden')
          }
        }

        updateDropdown(noOfPassengers);
      } else {
        $('#booking_number_of_passengers').val(previousPassengers);
        alert('Cannot change number of passengers - currently there are too many concessions');
      }
      
    });

    // ADD CONCESSION BUTTON
    $('#add-concession').click(function() {
      $('#concession-list').removeClass('hidden');
    });

    // DELETE CONCESSION BUTTON
    $('.cancel-concession').click(function() {
      var parent = $(this).parent('.concession-cont');
      parent.addClass('hidden');
      var idNum = parent.attr('id').slice(-1);
      parent.find('.count').html(0);
      var numOfConcess = $('#hidden-'+idNum).val();
      noOfAdults = parseInt($('#adult-ticket-no').html()) + parseInt(numOfConcess);
      $('#adult-ticket-no').html(noOfAdults);
      resetConcession(idNum, numOfConcess);
      updateAdults(noOfAdults);
      $('#concession-list .non-promo').show();
      if ($('#add-concession').hasClass('hidden')) {
        $('#add-concession').removeClass('hidden')
      }
    });

    // ON SELECTION OF CONCESSION
    $('#concession-list').on('change', function() {
      if ($(this).val() > 0) {
        $(this).addClass('hidden');
        if ($(this).val() == 5) {
          $('.promo-code').removeClass('hidden');
          $('#concession-list #promo').hide();
          $('#concession-list').val(0);
          if (noOfAdults <= 0) {
            $('#add-concession').addClass('hidden');
          }
        } else {
          currentConcessions++;
          if ( $('#concession-'+$(this).val()).hasClass('hidden')) {
            $('#concession-'+$(this).val()).removeClass('hidden');
            $('#concession-'+$(this).val()+ ' .count').html(1);
            addOnetoTotal($(this).val());
          } else {
            var num = parseInt($('#concession-'+$(this).val()+ ' .count').html()) + 1;
            $('#concession-'+$(this).val()+ ' .count').html(num);
            addOnetoTotal($(this).val());
          }
          $(this).val(0);
          noOfAdults--;
          updateAdults(noOfAdults);
          if (noOfAdults <= 0) {
            if (!$('.promo-code').hasClass('hidden')) {
              $('#add-concession').addClass('hidden');
            } else {
              $('#concession-list .non-promo').hide();
            }
          }
        }
      }
    });

    function addOnetoTotal(idNum) {
      var num = parseInt($('#hidden-'+idNum).val()) + 1;
      $('#hidden-'+idNum).val(parseInt(num));
      $('form.edit_booking').trigger("change");
    }

    function resetConcession(idNum, numOfConcess) {
      var num = parseInt($('#hidden-'+idNum).val()) - parseInt(numOfConcess);
      currentConcessions = currentConcessions - parseInt(numOfConcess);
      $('#hidden-'+idNum).val(parseInt(num));
      $('form.edit_booking').trigger("change");
    }

    function updateDropdown(passengers) {
      var totalAdults = passengers - currentConcessions;
      $('#adult-ticket-no').html(totalAdults + ' adult ticket');
      if (totalAdults > 1) {
        $('#adult-ticket-no').append('s');
      }
      if (totalAdults <= 0) {
        $('#adult-tickets').addClass('hidden');
      } else if ($('#adult-tickets').hasClass('hidden')) {
        $('#adult-tickets').removeClass('hidden');
      }
    }

    function updateAdults(adults) {
      $('#adult-ticket-no').html(adults + ' adult ticket');
      if (adults > 1) {
        $('#adult-ticket-no').append('s');
      }
      if (adults <= 0) {
        $('#adult-tickets').addClass('hidden');
      } else if ($('#adult-tickets').hasClass('hidden')) {
        $('#adult-tickets').removeClass('hidden');
      }
    }

    $('form.edit_booking').change(function() {
      $.get(
        "<%= price_api_route_booking_path(@route, @booking) %>",
        $(this).serialize()
      ).done(
        function( data ) {
          $("#single_price").html(data.single);
          $("#return_price").html(data.return);
        }
      );
    });

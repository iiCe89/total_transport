- content_for :top_sec do
  %ul.summary
    %li
      %i.fa.fa-fw.fa-map-marker.start
      = @booking.pickup_stop.name
    %li
      %i.fa.fa-fw.fa-flag.start
      = @booking.dropoff_stop.name

.container
  .inner
    = form_for [@route, @booking], url: route_booking_path(@route, @booking), method: :put do |form|

      %h3 Choose journey
      = render 'days', form: form
      
      #times.hidden
        = render 'times', form: form, journey_type: :journey_id, type: 'outward'
        
        = render 'times', form: form, journey_type: :return_journey_id, type: 'return'
      
      .landmarks.hidden
        
        = form.label :pickup_landmark_id, 'Please choose a pickup point'
        = form.select :pickup_landmark_id,
            options_from_collection_for_select(@booking.pickup_stop.landmarks, 'id', 'name'),
            include_blank: '-- Please Select --'
        
        = form.label :pickup_landmark_id, 'Please choose a dropoff point'
        = form.select :dropoff_landmark_id,
            options_from_collection_for_select(@booking.dropoff_stop.landmarks, 'id', 'name'),
            include_blank: '-- Please Select --'
      
      #details.hidden
      
        = form.label :number_of_passengers
        = form.select :number_of_passengers, 1..10

        %p#adult-tickets{:class => "bold #{" hidden" if @booking.number_of_adults == 0}"}
          %span#adult-ticket-no= pluralize @booking.number_of_adults, "adult ticket"
          (#{number_to_currency(@booking.adult_single_price, :unit => "£")} each)
        .concessions
          #concession-1{:class => "bold mb1 concession-cont#{" hidden" if @booking.child_tickets == 0}"}
            %span.count= @booking.child_tickets
            Child fare (#{number_to_currency(@booking.child_single_price, :unit => "£")} each)
            .cancel-concession.button.extra-small-button.negative.ml05.inline{:title => "Delete Concession"}
              %i.fa.fa-times{:title => "Delete Concession"}
              delete
          #concession-2{:class => "bold mb1 concession-cont#{" hidden" if @booking.older_bus_passes == 0}"}
            %span.count= @booking.older_bus_passes
            Older persons bus pass (£0.00 each)
            .cancel-concession.button.extra-small-button.negative.ml05.inline{:title => "Delete Concession"}
              %i.fa.fa-times{:title => "Delete Concession"}
              delete
          #concession-3{:class => "bold mb1 concession-cont#{" hidden" if @booking.disabled_bus_passes == 0}"}
            %span.count= @booking.disabled_bus_passes
            Disabled persons bus pass (£0.00 each)
            .cancel-concession.button.extra-small-button.negative.ml05.inline{:title => "Delete Concession"}
              %i.fa.fa-times{:title => "Delete Concession"}
              delete
          #concession-4{:class => "bold mb1 concession-cont#{" hidden" if @booking.scholar_bus_passes == 0}"}
            %span.count= @booking.scholar_bus_passes
            Scholarly Season Ticket (£0.00 each)
            .cancel-concession.button.extra-small-button.negative.ml05.inline{:title => "Delete Concession"}
              %i.fa.fa-times{:title => "Delete Concession"}
              delete
          %select#concession-list.hidden.select.mobFull
            %option#option-null{:value => "0"} Select a Concession
            %option#option-1.non-promo{:value => "1"} Child fare
            %option#option-2.non-promo{:value => "2"} Older persons bus pass
            %option#option-3.non-promo{:value => "3"} Disabled persons bus pass
            %option#option-4.non-promo{:value => "4"} Scholarly Season Ticket
            %option#promo{:value => "5"} Add Promo Code
          #add-concession{:class => "add button small-button#{" hidden" if @booking.number_of_adults == 0}"} + Add a Concessionary Fare
          .promo-code.hidden.mt2
            = form.label :promo_code, :class => "light"
            = form.text_field :promo_code, :class => "white-input"
          .hidden
            = form.label :child_tickets, "Child fare"
            = form.number_field :child_tickets, :id => "hidden-1"
            = form.label :older_bus_passes
            = form.number_field :older_bus_passes, :id => "hidden-2"
            = form.label :disabled_bus_passes
            = form.number_field :disabled_bus_passes, :id => "hidden-3"
            = form.label :scholar_bus_passes
            = form.number_field :scholar_bus_passes, :id => "hidden-4"
            
          %hr.dark-hr/
          #special-req-button.button.white-button.small-button
            %i.fa.fa-plus
            Add Special Requirements
          #special-req.hidden.mt1
            = form.label :special_requirements, "Describe your special requirements:", :class => "light"
            = form.text_field :special_requirements, :class => "white-input"
            %p.small Your transport provider will get in touch with you if they can't meet your needs
          %hr.dark-hr/
          
          = form.label :passenger_name, "Lead Passenger's Name"
          = form.text_field :passenger_name, class: "white-input"


          = form.label :phone_number
          = form.text_field :phone_number, class: "white-input mb1"
          %p
            Let us know your phone number so that we can notify you when your vehicle is on its way.
            
          = form.submit "Submit your booking request", :class => 'button alt-button'

- content_for :js do
  :javascript
    
    $('.date-button').click(function() {
      var target = $(this).data('selector');
      var type = $(this).data('type');
      $('#times').removeClass('hidden');
      $('#times .time').addClass('hidden');
      $(' .' + target).removeClass('hidden');
    })
    
    $('#return_times input').click(function() {
      $('.landmarks').removeClass('hidden');
    });
    
    $('#booking_dropoff_landmark_id').change(function() {
      $('#return-chooser').removeClass('hidden');
      $('#details').removeClass('hidden');
    });
    
    var noOfAdults = 0,
    previousPassengers = 0,
    currentConcessions = 0;

    $('#special-req-button').click(function() {
      if ($(this).hasClass('negative')) {
        $(this).removeClass('negative').html('<i class="fa fa-plus"></i> Add Special Requirements');
        $('#special-req').addClass('hidden');
        $('#special-req input').val('');
      } else {
        $(this).addClass('negative').html('<i class="fa fa-minus"></i> Remove Requirements');
        $('#special-req').removeClass('hidden');
      }
    });

    $('#booking_number_of_passengers').on('focus', function () {
        previousPassengers = this.value;
      }).on('change', function() {
      var noOfPassengers = $(this).val();
      if (noOfPassengers > (currentConcessions-1)) {
        checkPassengers(noOfPassengers);
        noOfAdults = noOfPassengers - currentConcessions;
        if (noOfAdults <= 0) {
          if (noOfAdults <= 0) {
            if (!$('.promo-code').hasClass('hidden')) {
              $('#add-concession').addClass('hidden');
            } else {
              $('#concession-list .non-promo').hide();
            }
          }
        } else {
          $('#concession-list .non-promo').show();
          if ($('#add-concession').hasClass('hidden')) {
            $('#add-concession').removeClass('hidden')
          }
        }

        updateDropdown(noOfPassengers);
      } else {
        $('#booking_number_of_passengers').val(previousPassengers);
        alert('Cannot change number of passengers - currently there are too many concessions');
      }
      
    });

    // ADD CONCESSION BUTTON
    $('#add-concession').click(function() {
      $('#concession-list').removeClass('hidden');
    });

    // DELETE CONCESSION BUTTON
    $('.cancel-concession').click(function() {
      var parent = $(this).parent('.concession-cont');
      parent.addClass('hidden');
      var idNum = parent.attr('id').slice(-1);
      parent.find('.count').html(0);
      var numOfConcess = $('#hidden-'+idNum).val();
      noOfAdults = parseInt($('#adult-ticket-no').html()) + parseInt(numOfConcess);
      $('#adult-ticket-no').html(noOfAdults);
      resetConcession(idNum, numOfConcess);
      updateAdults(noOfAdults);
      $('#concession-list .non-promo').show();
      if ($('#add-concession').hasClass('hidden')) {
        $('#add-concession').removeClass('hidden')
      }
    });

    // ON SELECTION OF CONCESSION
    $('#concession-list').on('change', function() {
      if ($(this).val() > 0) {
        $(this).addClass('hidden');
        if ($(this).val() == 5) {
          $('.promo-code').removeClass('hidden');
          $('#concession-list #promo').hide();
          $('#concession-list').val(0);
          if (noOfAdults <= 0) {
            $('#add-concession').addClass('hidden');
          }
        } else {
          currentConcessions++;
          if ( $('#concession-'+$(this).val()).hasClass('hidden')) {
            $('#concession-'+$(this).val()).removeClass('hidden');
            $('#concession-'+$(this).val()+ ' .count').html(1);
            addOnetoTotal($(this).val());
          } else {
            var num = parseInt($('#concession-'+$(this).val()+ ' .count').html()) + 1;
            $('#concession-'+$(this).val()+ ' .count').html(num);
            addOnetoTotal($(this).val());
          }
          $(this).val(0);
          noOfAdults--;
          updateAdults(noOfAdults);
          if (noOfAdults <= 0) {
            if (!$('.promo-code').hasClass('hidden')) {
              $('#add-concession').addClass('hidden');
            } else {
              $('#concession-list .non-promo').hide();
            }
          }
        }
      }
    });

    function addOnetoTotal(idNum) {
      var num = parseInt($('#hidden-'+idNum).val()) + 1;
      $('#hidden-'+idNum).val(parseInt(num));
      $('form.edit_booking').trigger("change");
    }

    function resetConcession(idNum, numOfConcess) {
      var num = parseInt($('#hidden-'+idNum).val()) - parseInt(numOfConcess);
      currentConcessions = currentConcessions - parseInt(numOfConcess);
      $('#hidden-'+idNum).val(parseInt(num));
      $('form.edit_booking').trigger("change");
    }

    function updateDropdown(passengers) {
      var totalAdults = passengers - currentConcessions;
      $('#adult-ticket-no').html(totalAdults + ' adult ticket');
      if (totalAdults > 1) {
        $('#adult-ticket-no').append('s');
      }
      if (totalAdults <= 0) {
        $('#adult-tickets').addClass('hidden');
      } else if ($('#adult-tickets').hasClass('hidden')) {
        $('#adult-tickets').removeClass('hidden');
      }
    }

    function updateAdults(adults) {
      $('#adult-ticket-no').html(adults + ' adult ticket');
      if (adults > 1) {
        $('#adult-ticket-no').append('s');
      }
      if (adults <= 0) {
        $('#adult-tickets').addClass('hidden');
      } else if ($('#adult-tickets').hasClass('hidden')) {
        $('#adult-tickets').removeClass('hidden');
      }
    }

    $('form.edit_booking').change(function() {
      $.get(
        "<%= price_api_route_booking_path(@route, @booking) %>",
        $(this).serialize()
      ).done(
        function( data ) {
          $("#single_price").html(data.single);
          $("#return_price").html(data.return);
        }
      );
    });

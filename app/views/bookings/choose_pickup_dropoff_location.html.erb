<% if @pickup_of_dropoff == 'pickup' %>
  <h1>Choose pick up location</h1>
<% else %>
  <h1>Choose Drop Off location</h1>
<% end %>
<div class="card-cont">
  <script type="text/javascript">
  var map
    function initMap() {
      var geoJson = <%= @stop.polygon.to_json.html_safe %>;
      map = new google.maps.Map(document.getElementById("map"), {});
      map.data.addGeoJson(geoJson);
      var polygon_feature;
      map.data.forEach(function(feature) {polygon_feature = feature.getGeometry()});
      var bounds = new google.maps.LatLngBounds();
      polygon_feature.forEachLatLng(function(ll) {bounds.extend(ll)});
      tightFitBounds(map, bounds);

      var polygon = new google.maps.Polygon({
        paths: polygon_feature.getArray()[0].getArray(),
      });

      $('<div/>').addClass('centerMarker').appendTo(map.getDiv());

      var last_position = map.getCenter();
      map.addListener('center_changed', function() {
        if(!google.maps.geometry.poly.containsLocation(map.getCenter(), polygon)) {
          map.setCenter(last_position);
        } else {
          last_position = map.getCenter();
          <% if @pickup_of_dropoff == 'pickup' %>
            $('#booking_pickup_lat').val(map.getCenter().lat());
            $('#booking_pickup_lng').val(map.getCenter().lng());
          <% else %>
            $('#booking_dropoff_lat').val(map.getCenter().lat());
            $('#booking_dropoff_lng').val(map.getCenter().lng());
          <% end %>
        }
      });
    }
  </script>

  <div class="card">
    <div id="map" style="margin-bottom:0"></div>

    <div id="confirmation">
      <% if @pickup_of_dropoff == 'pickup' %>
        <%= form_for [@route, @booking], url: save_pickup_location_route_booking_path(@route, @booking) do |form| %>
          <%= form.hidden_field :pickup_lat %>
          <%= form.hidden_field :pickup_lng %>
          <%= form.submit "Confirm Route", :class => 'cardBtn' %>
        <% end %>
      <% else %>
        <%= form_for [@route, @booking], url: save_dropoff_location_route_booking_path(@route, @booking) do |form| %>
          <%= form.hidden_field :dropoff_lat %>
          <%= form.hidden_field :dropoff_lng %>
          <%= form.submit "Confirm Route", :class => 'cardBtn'  %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<%= link_to "Suggest and edit to this stop", suggest_edit_to_stop_route_booking_path(@route, @booking, stop_id: @stop.id) %>

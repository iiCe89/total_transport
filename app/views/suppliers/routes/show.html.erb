<%= render partial: "layouts/suppliers_header" %>
<section id="editRoute">
  <h1><% @route.name %></h1>

  <h2>Stops:</h2>

  <div id="sortable_stops" class="stop-list">
    <% @route.stops.each do |stop| %>
      <div id="stop_<%= stop.id %>" class="stop card">
        <div class="edit_route_mins half">
          <span><%= link_to stop.name, edit_suppliers_route_stop_path(@route, stop) %></span>
        
          <% if stop != @route.stops.first %>
            <%= form_for [:suppliers, @route, stop] do |form| %>
              <p>
                <%= form.number_field :minutes_from_last_stop, class: 'minutes-field' %>
                minutes.
                <%= form.submit "Save" %>
              </p>
            <% end %>
          <% end %>
        </div>
        <div class="half">
          <div class="map_preview" data-geojson="<%= stop.polygon.to_json %>"></div>
        </div>
      </div>
    <% end %>
    <%= link_to new_suppliers_route_stop_path(@route) do %>
      <div class="cardBtn">
        <span>Add a New Stop</span>
      </div>
    <% end %>
  </div>

  

  <script type="text/javascript">
    var AUTH_TOKEN = $('meta[name=csrf-token]').attr('content');
    $('#sortable_stops').sortable({items:'.card', containment:'parent', axis:'y', update: function() {
      $.post('<%= sort_suppliers_route_path(@route) %>', '_method=put&authenticity_token='+AUTH_TOKEN+'&'+$(this).sortable('serialize'));
    }});

    function initMap() {
      $('.map_preview').each(function(i, m) {
        var map = new google.maps.Map(m, {});
        map.data.addGeoJson($(m).data('geojson'));
        var polygon;
        map.setOptions({draggable: false, scrollwheel:  false});
        map.data.forEach(function(feature) {polygon = feature.getGeometry()});
        var bounds = new google.maps.LatLngBounds();
        polygon.forEachLatLng(function(ll) {bounds.extend(ll)});
        tightFitBounds(map, bounds);
      });
    }
  </script>

</section>
<%= render partial: "layouts/suppliers_footer" %>

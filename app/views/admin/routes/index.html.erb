<section id="sup_routes">
  <% Route.all.each do |route| %>
     <div class="card">
      <div class="inner">
        <span class="sup_route_name"><i class="fa fa-bus"></i> <%= route.name %></span>
        
        <select multiple id="select_<%= route.id %>" class="waypoints" style="display:none;">
          <% route.stops.each do |stop| %>
            <option value="<%= stop.latitude %>, <%= stop.longitude %>" selected><%= stop.name %></option>
          <% end %>
        </select>

        <div id="map_<%= route.id %>" class="route_preview"></div>
         
        <hr>
        <span class="sup_route_journeys">
          <span class="numOfJourn"><%= route.journeys.count %></span> Current Journeys -
          <%= link_to admin_route_journeys_path(route) do %>
            <span class="addTxt">Add</span> Journeys to this Route
          <% end %>
        </span>
      </div>
      <%= link_to admin_route_path(route) do %>
        <div class="cardBtn">
          <span>Edit Route</span>
        </div>
      <% end %>
    </div>
  <% end %>
<%= form_for [:admin, Route.new] do |form| %>
  <%= form.submit "Create new Route" %>
<% end %>
</section>

<script type="text/javascript">
  $(function() {
    $('.sup_route_journeys').each(function() {
      if (parseInt($(this).find('.numOfJourn').html()) == 0) {
        $(this).find('.addTxt').html('Add');
      } else {
        $(this).find('.addTxt').html('Edit/Add');
      }
    });
  });

  function initMap() {
    $('.route_preview').each(function(i, m) {
      var directionsService = new google.maps.DirectionsService;
      var directionsDisplay = new google.maps.DirectionsRenderer;
      var map = new google.maps.Map(m, { scrollwheel:  false });
      directionsDisplay.setMap(map);

      calculateAndDisplayRoute(directionsService, directionsDisplay, $(this));
    });
  }

  function calculateAndDisplayRoute(directionsService, directionsDisplay, map) {
    var waypts = [];
    var idNum = map.attr('id').slice(4);
    var checkboxArray = document.getElementById('select_'+idNum);
    var start = checkboxArray[0].value;
    var end = checkboxArray[(checkboxArray.length-1)].value;
    console.log(checkboxArray.length)
    for (var i = 0; i < checkboxArray.length; i++) {
      if (checkboxArray.options[i].selected) {
        waypts.push({
          location: checkboxArray[i].value,
          stopover: true
        });
      }
    }
    waypts.shift();
    waypts.pop();
    directionsService.route({
      origin: start,
      destination: end,
      waypoints: waypts,
      optimizeWaypoints: true,
      travelMode: google.maps.TravelMode.DRIVING
    }, function(response, status) {
      if (status === google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
        var route = response.routes[0];
        console.log('DONE');
      } else {
        window.alert('Directions request failed due to ' + status);
      }
    });
  }
</script>

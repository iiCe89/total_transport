<div id="sup_edit_jrny">
  <h2>Add a New Journey</h2>

  <% if Route.exists? %>
    <% if current_team.vehicles.count > 0 %>
      <h3 id="sup_jrny_title">Select a Route:</h3>
      <%= form_for [:admin, @journey] do |form| %>
      <% Route.bookable_routes.each do |route| %>
        <div class="card sup_edit_jrny">
          <div class="inner">
            <div class="twoThird">
              <p class="highlight"><%= form.radio_button :route_id, route.id, class: 'routeRadio hidden' %> <%= route.name %></p>
              <p>Via <%= route.stops.count-2 %> Possible Stops:</p>
              <ul>
                <% route.stops[1..-2].each_with_index do |stop| %>
                  <li><%= stop.name %></li>
                <% end %>
              </ul>
            </div>
            <div class="third mobFull">
              <select multiple id="select_<%= route.id %>" class="waypoints" style="display:none;">
                <% route.stops.each do |stop| %>
                  <option value="<%= stop.latitude %>, <%= stop.longitude %>" selected><%= stop.name %></option>
                <% end %>
              </select>
              <div id="map_<%= route.id %>" class="route_preview"></div>
            </div>
          </div>
        </div>
      <% end %>

      <div class="card sup_edit_jrny_info" style="display: none;">
        <div class="inner">
          <%= render partial: 'fields', locals: {form: form} %>
        </div>
        <%= form.submit "Create Journey", :class => "cardBtn" %>
      </div>
      <% end %>
    </div>
  <% else %>
    <p>You currently have no vehicles <%= link_to "add one now", admin_vehicles_path %> before you can add a journey.</p>
  <% end %>
<% else %>
  <p>There are currently no routes, please check back again later for more routes to be added.</p>
<% end %>
<script type="text/javascript">
  $(function() {
    $('.sup_edit_jrny').click(function() {
      if (!$(this).hasClass('active')) {
        resetJrnyRoutes();
        $('.sup_edit_jrny').not(this).each(function(){
          $(this).addClass('inactive');
          $(this).slideUp();
        });
        $(this).find('input:radio').prop('checked',true);
        $(this).addClass('active');
        $('#sup_jrny_title').html('Selected Route:');
        $('.sup_edit_jrny_info').slideDown();
      } else {
        resetJrnyRoutes();
        $('.sup_edit_jrny_info').slideUp();
      }
    });
  });

  function resetJrnyRoutes() {
    $('.sup_edit_jrny').each(function(){
      $(this).find('input:radio').prop('checked',false);
      $(this).removeClass('inactive').removeClass('active');
      $(this).slideDown();
      $('#sup_jrny_title').html('Select a Route:');
    });
  }

  function initMap() {
    $('.route_preview').each(function(i, m) {
      var directionsService = new google.maps.DirectionsService;
      var directionsDisplay = new google.maps.DirectionsRenderer;
      var map = new google.maps.Map(m, {
        scrollwheel:  false,
        disableDefaultUI: true,
        scaleControl: true,
        draggable: false
      });
      directionsDisplay.setMap(map);

      calculateRouteMultiStop(directionsService, directionsDisplay, $(this));
    });
  }
</script>
